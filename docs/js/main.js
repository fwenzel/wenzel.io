var p=class{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.animations=new Map,this.active=null,this.activeName=null,this.overlay=null,this.lastTime=0,this.resizeObserver=null,this.transition=null,this.viewportWidth=0,this.viewportHeight=0}register(t,i){this.animations.set(t,i)}start(t){let i=this.animations.get(t);if(!i)throw new Error(`Unknown animation: ${t}`);this.active=i,this.activeName=t,this.active.init(this.ctx,this.canvas),this.overlay&&this.overlay.init(this.ctx,this.canvas),this.lastTime=performance.now(),requestAnimationFrame(h=>this.tick(h))}tick(t){if(!this.active)return;let i=Math.min(64,t-this.lastTime);this.lastTime=t,this.active.update(i),this.overlay&&this.overlay.update(i),this.active.render(),this.overlay&&this.overlay.render(),this.transition&&this.renderTransition(i),requestAnimationFrame(h=>this.tick(h))}bindResize(){let t=()=>{let{width:i,height:h}=this.canvas.getBoundingClientRect(),s=window.devicePixelRatio||1;this.canvas.width=Math.max(1,Math.floor(i*s)),this.canvas.height=Math.max(1,Math.floor(h*s)),this.ctx.setTransform(s,0,0,s,0,0),this.viewportWidth=i,this.viewportHeight=h,this.active&&this.active.onResize(i,h),this.overlay&&this.overlay.onResize(i,h)};"ResizeObserver"in window?(this.resizeObserver=new ResizeObserver(t),this.resizeObserver.observe(this.canvas)):window.addEventListener("resize",t),t()}setOverlay(t){this.overlay=t}switchTo(t){if(!t||t===this.activeName)return;if(!this.animations.get(t))throw new Error(`Unknown animation: ${t}`);this.transition={phase:"out",elapsed:0,duration:800,nextName:t}}renderTransition(t){if(!this.transition)return;let i=this.ctx,h=this.transition;h.elapsed+=t;let s=Math.min(1,h.elapsed/h.duration);if(h.phase==="out"&&s>=1){let a=this.animations.get(h.nextName);this.active=a,this.activeName=h.nextName,this.active.init(this.ctx,this.canvas),this.viewportWidth&&this.viewportHeight&&this.active.onResize(this.viewportWidth,this.viewportHeight),h.phase="in",h.elapsed=0}let e=h.phase==="out"?s:1-Math.min(1,h.elapsed/h.duration);i.save(),i.fillStyle=`rgba(5, 6, 8, ${e})`,i.fillRect(0,0,this.viewportWidth,this.viewportHeight),i.restore(),h.phase==="in"&&h.elapsed>=h.duration&&(this.transition=null)}};var x=class{constructor(){this.ctx=null,this.canvas=null,this.width=0,this.height=0,this.groups=[],this.fade=.1,this.time=0}init(t,i){this.ctx=t,this.canvas=i,this.reset()}reset(){this.groups=[];let t=3,i=5;for(let h=0;h<t;h+=1){let s=Math.floor(Math.random()*360),e=[],a=[];for(let l=0;l<i;l+=1){e.push({x:Math.random()*this.width,y:Math.random()*this.height});let n=40+Math.random()*80,c=Math.random()*Math.PI*2;a.push({x:Math.cos(c)*n,y:Math.sin(c)*n})}this.groups.push({hue:s,points:e,velocities:a})}}onResize(t,i){this.width=t,this.height=i,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,t,i),this.reset()}update(t){this.time+=t/1e3;let i=t/1e3;for(let h of this.groups)h.points.forEach((s,e)=>{let a=h.velocities[e];s.x+=a.x*i,s.y+=a.y*i,(s.x<=0||s.x>=this.width)&&(a.x*=-1),(s.y<=0||s.y>=this.height)&&(a.y*=-1),s.x=Math.max(0,Math.min(this.width,s.x)),s.y=Math.max(0,Math.min(this.height,s.y))})}render(){let t=this.ctx;t.fillStyle=`rgba(0, 0, 0, ${this.fade})`,t.fillRect(0,0,this.width,this.height),t.lineWidth=2,t.globalCompositeOperation="lighter";for(let i of this.groups)t.strokeStyle=`hsla(${i.hue}, 90%, 65%, 0.85)`,t.beginPath(),i.points.forEach((h,s)=>{s===0?t.moveTo(h.x,h.y):t.lineTo(h.x,h.y)}),t.closePath(),t.stroke();t.globalCompositeOperation="source-over"}};var b=class{constructor(){this.ctx=null,this.canvas=null,this.width=0,this.height=0,this.paddleHeight=80,this.paddleWidth=10,this.paddleInset=24,this.ballRadius=6,this.leftPaddle={y:0,vy:0},this.rightPaddle={y:0,vy:0},this.ball={x:0,y:0,vx:0,vy:0},this.fade=.18,this.leftError=(Math.random()-.5)*16,this.rightError=(Math.random()-.5)*16}init(t,i){this.ctx=t,this.canvas=i,this.reset()}onResize(t,i){this.width=t,this.height=i,this.paddleHeight=Math.max(70,Math.min(140,i*.18)),this.paddleWidth=Math.max(8,Math.min(14,t*.015)),this.ballRadius=Math.max(5,Math.min(9,t*.01)),this.paddleInset=Math.max(18,Math.min(40,t*.05)),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,t,i),this.reset()}reset(){this.leftError=(Math.random()-.5)*18,this.rightError=(Math.random()-.5)*18,this.leftPaddle.y=this.height/2,this.rightPaddle.y=this.height/2,this.leftPaddle.vy=0,this.rightPaddle.vy=0,this.ball.x=this.width/2,this.ball.y=this.height/2;let t=Math.max(180,Math.min(320,this.width*.25)),i=(Math.random()*.6-.3)*Math.PI,h=Math.random()>.5?1:-1;this.ball.vx=Math.cos(i)*t*h,this.ball.vy=Math.sin(i)*t}update(t){let i=t/1e3,h=this.getPaddleTargetY("left"),s=this.getPaddleTargetY("right");this.updatePaddle(this.leftPaddle,h,i,.9),this.updatePaddle(this.rightPaddle,s,i,.75),this.ball.x+=this.ball.vx*i,this.ball.y+=this.ball.vy*i,(this.ball.y-this.ballRadius<=0||this.ball.y+this.ballRadius>=this.height)&&(this.ball.vy*=-1,this.ball.y=Math.max(this.ballRadius,Math.min(this.height-this.ballRadius,this.ball.y)));let e=this.paddleInset+this.paddleWidth,a=this.width-this.paddleInset-this.paddleWidth;this.ball.vx<0&&this.ball.x-this.ballRadius<=e?this.handlePaddleHit(this.leftPaddle,e):this.ball.vx>0&&this.ball.x+this.ballRadius>=a&&this.handlePaddleHit(this.rightPaddle,a),(this.ball.x<-this.ballRadius*4||this.ball.x>this.width+this.ballRadius*4)&&this.reset()}updatePaddle(t,i,h,s){let e=(i-t.y)*s,a=Math.max(160,Math.min(320,this.height*.6));t.vy+=e*h*6,t.vy=Math.max(-a,Math.min(a,t.vy)),t.y+=t.vy*h,t.vy*=.92;let l=this.paddleHeight/2;t.y=Math.max(l,Math.min(this.height-l,t.y))}getPaddleTargetY(t){let i=t==="left"?this.paddleInset+this.paddleWidth:this.width-this.paddleInset-this.paddleWidth,h=t==="left"&&this.ball.vx<0||t==="right"&&this.ball.vx>0,s=t==="left"?this.leftError:this.rightError;if(!h||Math.abs(this.ball.vx)<10)return this.ball.y+s;let e=(i-this.ball.x)/this.ball.vx,a=this.ball.y+this.ball.vy*e;return this.reflectY(a)+s}reflectY(t){if(this.height<=0)return t;let i=(this.height-this.ballRadius)*2;if(i<=0)return t;let h=t;return(h<0||h>this.height)&&(h=(h%i+i)%i,h>this.height&&(h=i-h)),Math.max(this.ballRadius,Math.min(this.height-this.ballRadius,h))}handlePaddleHit(t,i){let h=this.paddleHeight/2;if(this.ball.y<t.y-h||this.ball.y>t.y+h)return;let e=(this.ball.y-t.y)/h*Math.PI*.35,a=Math.min(420,Math.hypot(this.ball.vx,this.ball.vy)*1.03),l=this.ball.vx<0?1:-1;this.ball.vx=Math.cos(e)*a*l,this.ball.vy=Math.sin(e)*a,l>0?this.ball.x=i+this.ballRadius+1:this.ball.x=i-this.ballRadius-1}render(){let t=this.ctx;t.fillStyle=`rgba(5, 6, 8, ${this.fade})`,t.fillRect(0,0,this.width,this.height),t.fillStyle="rgba(210, 210, 210, 0.7)";let i=12,h=18;for(let s=h;s<this.height-h;s+=i+h)t.fillRect(this.width/2-1,s,2,i);t.fillStyle="rgba(235, 235, 235, 0.85)",t.fillRect(this.paddleInset,this.leftPaddle.y-this.paddleHeight/2,this.paddleWidth,this.paddleHeight),t.fillRect(this.width-this.paddleInset-this.paddleWidth,this.rightPaddle.y-this.paddleHeight/2,this.paddleWidth,this.paddleHeight),t.beginPath(),t.arc(this.ball.x,this.ball.y,this.ballRadius,0,Math.PI*2),t.fill()}};var M=class{constructor(){this.ctx=null,this.canvas=null,this.width=0,this.height=0,this.pretzels=[],this.sprites=[],this.fade=.2}init(t,i){this.ctx=t,this.canvas=i,this.sprites=this.buildPretzelSprites(),this.reset()}onResize(t,i){this.width=t,this.height=i,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,t,i),this.reset()}reset(){let t=Math.max(8,Math.min(24,this.width*this.height/4e4)),i=Math.round(t);this.pretzels=Array.from({length:i},()=>this.spawnPretzel())}spawnPretzel(){let t=this.sprites[Math.floor(Math.random()*this.sprites.length)],i=36+Math.random()*110,h=30+Math.random()*90,s=Math.floor(Math.random()*4),e=0,a=0,l=0;return s===0?(e=-i,a=Math.random()*this.height,l=(-.35+Math.random()*.7)*Math.PI):s===1?(e=this.width+i,a=Math.random()*this.height,l=(.65+Math.random()*.7)*Math.PI):s===2?(e=Math.random()*this.width,a=-i,l=(.15+Math.random()*.7)*Math.PI):(e=Math.random()*this.width,a=this.height+i,l=(-.85+Math.random()*.7)*Math.PI),{sprite:t,x:e,y:a,size:i,vx:Math.cos(l)*h,vy:Math.sin(l)*h,rotation:Math.random()*Math.PI*2,rotationSpeed:(-.7+Math.random()*1.4)*Math.PI,alpha:.5+Math.random()*.4}}update(t){let i=t/1e3,h=180;for(let s=0;s<this.pretzels.length;s+=1){let e=this.pretzels[s];e.x+=e.vx*i,e.y+=e.vy*i,e.rotation+=e.rotationSpeed*i,(e.x<-h||e.x>this.width+h||e.y<-h||e.y>this.height+h)&&(this.pretzels[s]=this.spawnPretzel())}}render(){let t=this.ctx;t.fillStyle=`rgba(5, 6, 8, ${this.fade})`,t.fillRect(0,0,this.width,this.height);for(let i of this.pretzels){let h=i.sprite;if(!h||!h.complete)continue;let s=i.size/h.width,e=h.width*s,a=h.height*s;t.save(),t.translate(i.x,i.y),t.rotate(i.rotation),t.globalAlpha=i.alpha,t.drawImage(h,-e/2,-a/2,e,a),t.restore()}}buildPretzelSprites(){let t=new Image;return t.src="img/pretzel.svg",[t]}};var u=class{constructor(){this.ctx=null,this.canvas=null,this.width=0,this.height=0,this.fade=.18,this.palette=[{h:200,s:90,l:60},{h:120,s:75,l:55},{h:46,s:95,l:58},{h:330,s:80,l:62},{h:12,s:90,l:56}],this.colorIndex=0,this.position={x:0,y:0},this.velocity={x:0,y:0},this.drawWidth=0,this.drawHeight=0,this.halfWidth=0,this.halfHeight=0,this.logo=null,this.logoAspect=2.28,this.svgText=null,this.pendingLoad=null}init(t,i){this.ctx=t,this.canvas=i,this.loadSvg();let h=i.getBoundingClientRect();h.width&&h.height?this.onResize(h.width,h.height):this.reset()}onResize(t,i){this.width=t,this.height=i,this.updateDrawSize(),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,t,i),this.reset()}reset(){if(!this.width||!this.height)return;this.colorIndex=Math.floor(Math.random()*this.palette.length),this.refreshLogo();let t=Math.random()*Math.PI*2,i=Math.max(90,Math.min(220,Math.min(this.width,this.height)*.35));this.velocity.x=Math.cos(t)*i,this.velocity.y=Math.sin(t)*i,this.resetPosition()}resetPosition(){!this.width||!this.height||(this.position.x=this.halfWidth+Math.random()*Math.max(1,this.width-this.halfWidth*2),this.position.y=this.halfHeight+Math.random()*Math.max(1,this.height-this.halfHeight*2))}loadSvg(){this.pendingLoad||this.svgText||(this.pendingLoad=fetch("img/dvd.svg").then(t=>t.text()).then(t=>{this.svgText=t,this.refreshLogo()}).catch(()=>{this.svgText=null}))}updateDrawSize(){let i=Math.max(36,Math.min(this.height*.16,120)),h=i*this.logoAspect,s=this.width*.8;h>s&&(h=s,i=h/this.logoAspect),this.drawWidth=h,this.drawHeight=i,this.halfWidth=h/2,this.halfHeight=i/2}refreshLogo(){if(!this.svgText)return;let t=this.palette[this.colorIndex],i=this.formatHsl(t.h,t.s,t.l),h=this.injectFill(this.svgText,i),s=new Image;s.onload=()=>{s.width&&s.height&&(this.logoAspect=s.width/s.height,this.updateDrawSize()),this.logo=s},s.src=`data:image/svg+xml;utf8,${encodeURIComponent(h)}`}injectFill(t,i){let h=t.match(/<svg\b[^>]*>/);if(!h)return t;let s=h[0],e;return/\sfill=/.test(s)?e=s.replace(/\sfill="[^"]*"/,` fill="${i}"`):e=s.replace("<svg",`<svg fill="${i}"`),t.replace(s,e)}update(t){let i=t/1e3;this.position.x+=this.velocity.x*i,this.position.y+=this.velocity.y*i;let h=!1;this.position.x-this.halfWidth<=0?(this.position.x=this.halfWidth,this.velocity.x=Math.abs(this.velocity.x),h=!0):this.position.x+this.halfWidth>=this.width&&(this.position.x=this.width-this.halfWidth,this.velocity.x=-Math.abs(this.velocity.x),h=!0),this.position.y-this.halfHeight<=0?(this.position.y=this.halfHeight,this.velocity.y=Math.abs(this.velocity.y),h=!0):this.position.y+this.halfHeight>=this.height&&(this.position.y=this.height-this.halfHeight,this.velocity.y=-Math.abs(this.velocity.y),h=!0),h&&this.advanceColor()}advanceColor(){this.colorIndex=(this.colorIndex+1)%this.palette.length,this.refreshLogo()}render(){let t=this.ctx;t.fillStyle=`rgba(5, 6, 8, ${this.fade})`,t.fillRect(0,0,this.width,this.height),!(!this.logo||!this.logo.complete)&&(t.save(),t.imageSmoothingEnabled=!1,t.drawImage(this.logo,this.position.x-this.halfWidth,this.position.y-this.halfHeight,this.drawWidth,this.drawHeight),t.restore())}formatHsl(t,i,h){return`hsl(${t}, ${i}%, ${h}%)`}};var v=class{constructor(){this.ctx=null,this.canvas=null,this.width=0,this.height=0,this.label=null,this.labelMetrics=null,this.glitchTimer=0,this.nextGlitchIn=3+Math.random()*6}init(t,i){this.ctx=t,this.canvas=i,this.width&&this.height&&(this.labelMetrics=this.computeLabelMetrics(),this.label=this.buildLabel())}onResize(t,i){this.width=t,this.height=i,this.labelMetrics=this.computeLabelMetrics(),this.label=this.buildLabel()}update(t){this.updateLabel(t/1e3),this.updateGlitch(t/1e3)}render(){this.renderLabels()}buildLabel(){this.labelMetrics||(this.labelMetrics=this.computeLabelMetrics());let{width:t,height:i,margin:h}=this.labelMetrics,s=h+t/2,e=Math.max(s,this.width-h-t/2),a=h+i/2,l=Math.max(a,this.height-h-i/2);return{x:s+Math.random()*(e-s),y:a+Math.random()*(l-a),alpha:0,direction:1,speed:.08+Math.random()*.05}}updateLabel(t){this.label&&(this.label.alpha+=this.label.direction*this.label.speed*t,this.label.alpha>=.5&&(this.label.alpha=.5,this.label.direction=-1),this.label.alpha<=0&&(this.label=this.buildLabel()))}renderLabels(){let t=this.ctx;if(!this.label||!this.labelMetrics||!this.labelMetrics.sprite)return;let{sprite:i,scale:h}=this.labelMetrics;if(!i.complete)return;let s=i.width*h,e=i.height*h;t.save(),t.globalAlpha=this.label.alpha,t.imageSmoothingEnabled=!1;let a=this.label.x-s/2,l=this.label.y-e/2;this.renderStatic(t,a,l,s,e);let n=this.glitchTimer>0?(Math.random()-.5)*12:0;if(t.drawImage(i,a+n,l,s,e),this.glitchTimer>0){let c=3+Math.floor(Math.random()*4);for(let m=0;m<c;m+=1){let d=Math.max(2,Math.floor(e*.1)),f=Math.floor(Math.random()*(e-d)),g=l+f+(Math.random()-.5)*10,w=a+(Math.random()-.5)*18;t.drawImage(i,0,f/h,i.width,d/h,w,g,s,d)}}t.restore()}computeLabelMetrics(){let t=Math.max(18,Math.min(this.width,this.height)*.06),i="wenzel.io",h=this.getPixelFont(),s=i.length*h.width+(i.length-1)*h.spacing,e=h.height,a=this.buildLabelSprite(i,h,s,e),l=t/e,n=Math.max(24,t*.75);return{width:s*l,height:e*l,margin:n,scale:l,sprite:a}}getPixelFont(){return{width:5,height:7,spacing:1,glyphs:{w:["10001","10001","10001","10101","10101","10101","01010"],e:["01110","10001","11111","10000","10000","10001","01110"],n:["10001","11001","10101","10011","10001","10001","10001"],z:["11111","00001","00010","00100","01000","10000","11111"],l:["10000","10000","10000","10000","10000","10000","11111"],i:["00100","00000","01100","00100","00100","00100","01110"],o:["01110","10001","10001","10001","10001","10001","01110"],".":["00000","00000","00000","00000","00000","00100","00100"]}}}buildLabelSprite(t,i,h,s){let e=[],a=0;for(let c of t)(i.glyphs[c]||i.glyphs["."]).forEach((d,f)=>{for(let g=0;g<d.length;g+=1)d[g]==="1"&&e.push(`<rect x="${a+g}" y="${f}" width="1" height="1" />`)}),a+=i.width+i.spacing;let l=`
      <svg xmlns="http://www.w3.org/2000/svg" width="${h}" height="${s}">
        <g fill="#aaaaaa">${e.join("")}</g>
      </svg>
    `.trim(),n=new Image;return n.src=`data:image/svg+xml;utf8,${encodeURIComponent(l)}`,n}renderStatic(t,i,h,s,e){let a=this.glitchTimer>0?.5:.08;if(Math.random()>a)return;let l=this.glitchTimer>0?40:14;t.save(),t.globalAlpha*=this.glitchTimer>0?.6:.35,t.fillStyle="#b8b8b8";for(let n=0;n<l;n+=1){let c=i+Math.random()*s,m=h+Math.random()*e,d=Math.random()>.7?2:1;t.fillRect(c,m,d,d)}t.restore()}updateGlitch(t){this.nextGlitchIn-=t,this.nextGlitchIn<=0&&(this.glitchTimer=.35+Math.random()*.5,this.nextGlitchIn=1.8+Math.random()*4),this.glitchTimer>0&&(this.glitchTimer=Math.max(0,this.glitchTimer-t))}};var R=document.getElementById("stage"),r=new p(R);r.setOverlay(new v);r.register("mystify",new x);r.register("pong",new b);r.register("pretzels",new M);r.register("dvd",new u);r.bindResize();var P=Array.from(r.animations.keys()),y=o=>{let t=P.filter(i=>i!==o);return t.length===0?o:t[Math.floor(Math.random()*t.length)]},z=y(null);r.start(z);window.setInterval(()=>{let o=y(r.activeName);r.switchTo(o)},1e4);
